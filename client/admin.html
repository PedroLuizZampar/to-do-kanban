<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Kanban</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <header class="topbar">
      <h1 class="brand">
        <span class="material-symbols-outlined" aria-hidden="true">admin_panel_settings</span>
        <span>Admin</span>
      </h1>
      <div class="actions">
        <button id="btn-logout" class="btn-danger" title="Sair">
          <span class="material-symbols-outlined">logout</span>
          <span>Sair</span>
        </button>
      </div>
    </header>

    <main style="padding: 16px;">
      <h2>Usuários</h2>
      <div id="users-error" class="toast toast-error hidden"></div>
      <table id="users-table" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">ID</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Usuário</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Email</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Admin</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Ações</th>
          </tr>
        </thead>
        <tbody id="users-body"></tbody>
      </table>
    </main>

    <!-- Containers de toast e modal padrão do projeto -->
    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
    <div id="modal-backdrop" class="modal-backdrop hidden"></div>
    <div id="modal" class="modal hidden" role="dialog" aria-modal="true"></div>

    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/modals.js"></script>
    <script>
      // Usa o helper global "api" de utils.js
      async function listUsers() {
        return api.get('/api/admin/users');
      }
      async function resetPasswordUser(id) {
        return api.post('/api/admin/users/' + id + '/reset-password', {});
      }
      async function removeUserById(id) {
        return api.del('/api/admin/users/' + id);
      }

      function ensureAdmin() {
        if (!window.$auth.checkAuth()) return false;
        const user = window.$auth.getUser();
        if (!user || !user.is_admin) { window.location.href = '/'; return false; }
        return true;
      }

      function renderUsers(users) {
        const body = document.getElementById('users-body');
        body.innerHTML = '';
        users.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:8px; border-bottom:1px solid var(--border);">${u.id}</td>
            <td style="padding:8px; border-bottom:1px solid var(--border);">${u.username}</td>
            <td style="padding:8px; border-bottom:1px solid var(--border);">${u.email}</td>
            <td style="padding:8px; border-bottom:1px solid var(--border);">${u.is_admin ? 'Sim' : 'Não'}</td>
            <td style="padding:8px; border-bottom:1px solid var(--border); display:flex; gap:8px;">
              <button data-act="reset" data-id="${u.id}" data-username="${u.username}"><span class="material-symbols-outlined">key</span> Resetar senha</button>
              <button class="btn-danger" data-act="remove" data-id="${u.id}" data-username="${u.username}"><span class="material-symbols-outlined">delete</span> Remover</button>
            </td>`;
          body.appendChild(tr);
        });
      }

      async function load() {
        try {
          const users = await listUsers();
          renderUsers(users);
        } catch (e) {
          const el = document.getElementById('users-error');
          el.textContent = e.message || 'Erro';
          el.classList.remove('hidden');
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        if (!ensureAdmin()) return;
        load();

        document.getElementById('users-body').addEventListener('click', async (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const id = Number(btn.dataset.id);
          const act = btn.dataset.act;
          const username = btn.dataset.username || 'usuário';
          try {
            if (act === 'reset') {
              const ok = await (window.$modals?.confirm ? window.$modals.confirm({
                title: 'Redefinir senha',
                message: `Redefinir a senha de \"${username}\" para \"mudar123\"?`,
                confirmText: 'Redefinir',
                cancelText: 'Cancelar'
              }) : Promise.resolve(confirm('Redefinir a senha para "mudar123"?')));
              if (!ok) return;
              await resetPasswordUser(id);
              if (window.$modals?.alert) {
                await window.$modals.alert({ title: 'Senha redefinida', message: 'A nova senha é: mudar123' });
              } else {
                alert('A nova senha é: mudar123');
              }
            } else if (act === 'remove') {
              const ok = await (window.$modals?.confirm ? window.$modals.confirm({
                title: 'Remover usuário',
                message: `Remover o usuário \"${username}\"? Esta ação é irreversível.`,
                confirmText: 'Excluir',
                cancelText: 'Cancelar'
              }) : Promise.resolve(confirm('Remover este usuário?')));
              if (!ok) return;
              await removeUserById(id);
              if (window.$modals?.toast) window.$modals.toast('Usuário removido');
              await load();
            }
          } catch (err) {
            if (window.$modals?.alert) await window.$modals.alert({ title: 'Erro', message: err.message || 'Erro na ação' });
            else alert(err.message || 'Erro na ação');
          }
        });

        document.getElementById('btn-logout').addEventListener('click', () => window.$auth.logout());
        });
    </script>
  </body>
</html>
